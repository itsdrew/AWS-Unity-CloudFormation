AWSTemplateFormatVersion: 2010-09-09
Outputs:
  DevIdentityPoolId:
    Description: IdentityPoolId to put in DEV manager
    Export:
      Name:
        Fn::Join:
        - '-'
        - - Ref: ProjectName
          - Dev
          - IdentityPool::Id
    Value:
      Ref: DevIdentityPool
  UserIdentityPoolId:
    Description: IdentityPoolId to put in the auth manager
    Export:
      Name:
        Fn::Join:
        - '-'
        - - Ref: ProjectName
          - User
          - IdentityPool::Id
    Value:
      Ref: IdentityPool
Parameters:
  AuthorizedLambdas:
    Description: 'Comma delimited list of lambda arns that authorized client can use.
      Ex: arn:...:function:FlushLeaderboards,arn:...:function:GetLeaderboard'
    Type: CommaDelimitedList
  FacebookAppId:
    Description: 'Facebook app id. Ex: 12345678901234'
    Type: String
  GoogleClientId:
    Description: 'Google client id. Ex: 123456789012.apps.googleusercontent.com'
    Type: String
  ProjectName:
    Description: All resources generated by this stack will contain this name
    Type: String
  TwitterConsumerKey:
    Description: Twitter consumer key.
    Type: String
  TwitterConsumerSecret:
    Description: Twitter consumer secret.
    Type: String
  UnauthorizedLambdas:
    Description: 'Comma delimited list of lambda arns that unauthorized client can
      use. Ex: arn:...:function:FlushLeaderboards,arn:...:function:GetLeaderboard'
    Type: CommaDelimitedList
Resources:
  AuthRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRoleWithWebIdentity
          Condition:
            ForAnyValue:StringLike:
              cognito-identity.amazonaws.com:amr: authenticated
            StringEquals:
              cognito-identity.amazonaws.com:aud:
                Ref: IdentityPool
          Effect: Allow
          Principal:
            Federated: cognito-identity.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Statement:
          - Action:
            - mobileanalytics:PutEvents
            - cognito-sync:*
            - cognito-identity:*
            Effect: Allow
            Resource: '*'
          - Action:
            - lambda:InvokeFunction
            Effect: Allow
            Resource:
              Ref: AuthorizedLambdas
          - Action:
            - s3:GetObject
            Effect: Allow
            Resource:
            - Fn::Join:
              - /
              - - Fn::GetAtt:
                  - S3Bucket
                  - Arn
                - private
                - '*'
            - Fn::Join:
              - /
              - - Fn::GetAtt:
                  - S3Bucket
                  - Arn
                - public
                - '*'
          Version: 2012-10-17
        PolicyName:
          Fn::Join:
          - _
          - - Ref: ProjectName
            - auth
            - policy
      RoleName:
        Fn::Join:
        - _
        - - Ref: ProjectName
          - auth
          - role
    Type: AWS::IAM::Role
  DevIdentityPool:
    Properties:
      AllowUnauthenticatedIdentities: true
      IdentityPoolName:
        Fn::Join:
        - _
        - - Ref: ProjectName
          - dev
          - pool
    Type: AWS::Cognito::IdentityPool
  DevIdentityPoolRoleMapping:
    Properties:
      IdentityPoolId:
        Ref: DevIdentityPool
      Roles:
        authenticated:
          Fn::GetAtt:
          - DevRole
          - Arn
        unauthenticated:
          Fn::GetAtt:
          - DevRole
          - Arn
    Type: AWS::Cognito::IdentityPoolRoleAttachment
  DevRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRoleWithWebIdentity
          Condition:
            ForAnyValue:StringLike:
              cognito-identity.amazonaws.com:amr: unauthenticated
            StringEquals:
              cognito-identity.amazonaws.com:aud:
                Ref: DevIdentityPool
          Effect: Allow
          Principal:
            Federated: cognito-identity.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Statement:
          - Action:
            - s3:*
            Effect: Allow
            Resource:
            - Fn::Join:
              - /
              - - Fn::GetAtt:
                  - S3Bucket
                  - Arn
            - Fn::Join:
              - /
              - - Fn::GetAtt:
                  - S3Bucket
                  - Arn
                - '*'
          Version: 2012-10-17
        PolicyName:
          Fn::Join:
          - _
          - - Ref: ProjectName
            - dev
            - policy
      RoleName:
        Fn::Join:
        - _
        - - Ref: ProjectName
          - dev
          - role
    Type: AWS::IAM::Role
  IdentityPool:
    Properties:
      AllowUnauthenticatedIdentities: true
      IdentityPoolName:
        Fn::Join:
        - _
        - - Ref: ProjectName
          - pool
      SupportedLoginProviders:
        accounts.google.com:
          Ref: GoogleClientId
        api.twitter.com:
          Fn::Join:
          - ;
          - - Ref: TwitterConsumerKey
            - Ref: TwitterConsumerSecret
        graph.facebook.com:
          Ref: FacebookAppId
    Type: AWS::Cognito::IdentityPool
  IdentityPoolRoleMapping:
    Properties:
      IdentityPoolId:
        Ref: IdentityPool
      Roles:
        authenticated:
          Fn::GetAtt:
          - AuthRole
          - Arn
        unauthenticated:
          Fn::GetAtt:
          - UnauthRole
          - Arn
    Type: AWS::Cognito::IdentityPoolRoleAttachment
  S3Bucket:
    Properties:
      BucketName:
        Fn::Join:
        - '-'
        - - Ref: ProjectName
          - bucket
    Type: AWS::S3::Bucket
  UnauthRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRoleWithWebIdentity
          Condition:
            ForAnyValue:StringLike:
              cognito-identity.amazonaws.com:amr: unauthenticated
            StringEquals:
              cognito-identity.amazonaws.com:aud:
                Ref: IdentityPool
          Effect: Allow
          Principal:
            Federated: cognito-identity.amazonaws.com
        Version: 2012-10-17
      Policies:
      - PolicyDocument:
          Statement:
          - Action:
            - mobileanalytics:PutEvents
            Effect: Allow
            Resource: '*'
          - Action:
            - lambda:InvokeFunction
            Effect: Allow
            Resource:
              Ref: UnauthorizedLambdas
          - Action:
            - s3:GetObject
            Effect: Allow
            Resource:
            - Fn::Join:
              - /
              - - Fn::GetAtt:
                  - S3Bucket
                  - Arn
                - public
                - '*'
          Version: 2012-10-17
        PolicyName:
          Fn::Join:
          - _
          - - Ref: ProjectName
            - unauth
            - policy
      RoleName:
        Fn::Join:
        - _
        - - Ref: ProjectName
          - unauth
          - role
    Type: AWS::IAM::Role
